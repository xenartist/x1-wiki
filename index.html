<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X1.Wiki - Top 100 Projects on X1 Blockchain</title>
    <script src="https://unpkg.com/@solana/web3.js@1.87.0/lib/index.iife.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #333333;
            --primary-color: #0061c8;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-color: #dee2e6;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px 0;
            border-bottom: 2px solid var(--border-color);
        }

        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            color: var(--primary-color);
        }

        .header p {
            margin: 10px 0 0;
            font-size: 1.2rem;
            color: var(--secondary-color);
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: var(--secondary-color);
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
        }

        tbody tr:hover {
            background: rgba(0, 123, 255, 0.05);
        }

        .rank {
            font-weight: bold;
            width: 80px;
        }

        .rank-medal {
            font-size: 1.2rem;
        }

        .project-id {
            font-family: 'Courier New', monospace;
            font-weight: 500;
        }

        .project-name {
            font-weight: 600;
            color: var(--text-color);
        }

        .project-description {
            margin-top: 300px;
            word-wrap: break-word;
            font-size: 0.9rem;
            color: var(--secondary-color);
            line-height: 1.4;
        }

        .burned-amount {
            font-weight: bold;
            color: var(--success-color);
        }

        .website-link {
            color: var(--primary-color);
            text-decoration: none;
        }

        .website-link:hover {
            text-decoration: underline;
        }

        .refresh-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            margin: 20px 0;
        }

        .refresh-btn:hover {
            background: #0056b3;
        }

        .refresh-btn:disabled {
            background: var(--secondary-color);
            cursor: not-allowed;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px 0;
            border-top: 1px solid var(--border-color);
            color: var(--secondary-color);
            font-size: 0.9rem;
        }

        .footer a {
            color: var(--primary-color);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            table {
                font-size: 0.9rem;
            }

            th, td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>X1.Wiki</h1>
            <p>Top 100 Projects on X1 Blockchain</p>
        </div>

        <button class="refresh-btn" id="refreshBtn" onclick="loadLeaderboard()">
            <i class="fas fa-sync-alt"></i> Refresh Data
        </button>

        <div id="loadingMessage" class="loading">
            Loading leaderboard data from X1 blockchain...
        </div>

        <div id="errorMessage" class="error" style="display: none;"></div>

        <div class="table-container" id="leaderboardTable" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th class="rank">Rank</th>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Website</th>
                        <th>Burned (MEMO)</th>
                    </tr>
                </thead>
                <tbody id="leaderboardBody">
                </tbody>
            </table>
        </div>

        <div class="footer">
            <p><strong>Create your own project on <a href="https://beta.memo.rip">https://beta.memo.rip</a></strong></p>
            <p><a href="https://x1.wiki">x1.wiki</a> is maintained by <a href="https://x.com/xen_artist">@xen_artist</a></p>
        </div>
    </div>

    <script>
        const RPC_URL = 'https://rpc.testnet.x1.xyz';
        const MEMO_PROJECT_PROGRAM_ID = 'ENVapgjzzMjbRhLJ279yNsSgaQtDYYVgWq98j54yYnyx';

        let connection;

        // Initialize connection
        function initConnection() {
            connection = new solanaWeb3.Connection(RPC_URL, 'confirmed');
        }

        // Calculate PDA (Program Derived Address)
        function calculatePDA(seeds, programId) {
            return solanaWeb3.PublicKey.findProgramAddressSync(seeds, new solanaWeb3.PublicKey(programId));
        }

        // Parse leaderboard data
        function parseLeaderboardData(data) {
            if (data.length < 13) {
                throw new Error('Data too short for leaderboard structure');
            }

            let offset = 8; // Skip discriminator

            // Read current_size (u8)
            const currentSize = data[offset];
            offset += 1;

            // Read Vec length (u32)
            const vecLength = new DataView(data.buffer, offset, 4).getUint32(0, true);
            offset += 4;

            // Verify data consistency
            if (currentSize !== vecLength) {
                throw new Error(`Inconsistent data: current_size (${currentSize}) != vec_length (${vecLength})`);
            }

            // Read entries
            const entries = [];
            for (let i = 0; i < vecLength; i++) {
                const entryOffset = offset + (i * 16);
                
                const projectId = new DataView(data.buffer, entryOffset, 8).getBigUint64(0, true);
                const burnedAmount = new DataView(data.buffer, entryOffset + 8, 8).getBigUint64(0, true);

                entries.push({
                    projectId: Number(projectId),
                    burnedAmount: burnedAmount
                });
            }

            return {
                currentSize,
                entries
            };
        }

        // Parse project data
        function parseProjectData(data) {
            if (data.length < 8) {
                throw new Error('Data too short');
            }

            let offset = 8; // Skip discriminator
            offset += 8; // Skip project_id

            // Read creator (32 bytes)
            const creator = new solanaWeb3.PublicKey(data.slice(offset, offset + 32));
            offset += 32;

            // Skip timestamps
            offset += 16; // created_at + last_updated

            // Read name string
            const nameLength = new DataView(data.buffer, offset, 4).getUint32(0, true);
            offset += 4;
            const name = new TextDecoder().decode(data.slice(offset, offset + nameLength));
            offset += nameLength;

            // Read description string
            const descLength = new DataView(data.buffer, offset, 4).getUint32(0, true);
            offset += 4;
            const description = new TextDecoder().decode(data.slice(offset, offset + descLength));
            offset += descLength;

            // Skip image string
            const imageLength = new DataView(data.buffer, offset, 4).getUint32(0, true);
            offset += 4;
            offset += imageLength;

            // Read website string
            const websiteLength = new DataView(data.buffer, offset, 4).getUint32(0, true);
            offset += 4;
            const website = new TextDecoder().decode(data.slice(offset, offset + websiteLength));

            return {
                name,
                creator,
                description,
                website
            };
        }

        // Truncate description to specified length
        function truncateDescription(description, maxLength = 128) {
            if (!description || description.length <= maxLength) {
                return description || '';
            }
            return description.substring(0, maxLength) + '...';
        }

        // Format large numbers with commas
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // Get rank medal emoji
        function getRankMedal(rank) {
            switch (rank) {
                case 1: return '<i class="fas fa-trophy" style="color: #FFD700;"></i>';
                case 2: return '<i class="fas fa-medal" style="color: #C0C0C0;"></i>';
                case 3: return '<i class="fas fa-medal" style="color: #CD7F32;"></i>';
                default: return '<i class="fas fa-fire" style="color: #FF6B35;"></i>';
            }
        }

        // Show error message
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('leaderboardTable').style.display = 'none';
        }

        // Load and display leaderboard
        async function loadLeaderboard() {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Loading...';

            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('leaderboardTable').style.display = 'none';

            try {
                // Calculate burn leaderboard PDA
                const [burnLeaderboardPDA] = calculatePDA(
                    [new TextEncoder().encode('burn_leaderboard')], 
                    MEMO_PROJECT_PROGRAM_ID
                );

                console.log('Burn Leaderboard PDA:', burnLeaderboardPDA.toString());

                // Get leaderboard account data
                const accountInfo = await connection.getAccountInfo(burnLeaderboardPDA);
                
                if (!accountInfo) {
                    throw new Error('Burn leaderboard not found. It may not be initialized yet.');
                }

                console.log('Leaderboard data length:', accountInfo.data.length);

                // Parse leaderboard data
                const leaderboard = parseLeaderboardData(accountInfo.data);
                console.log('Parsed leaderboard:', leaderboard);

                // Sort entries by burned amount (descending)
                const sortedEntries = leaderboard.entries.slice().sort((a, b) => {
                    if (a.burnedAmount > b.burnedAmount) return -1;
                    if (a.burnedAmount < b.burnedAmount) return 1;
                    return 0;
                });

                // Get project details for top entries
                const projectDetails = await Promise.all(
                    sortedEntries.slice(0, 100).map(async (entry) => {
                        try {
                            const projectIdBytes = new ArrayBuffer(8);
                            const view = new DataView(projectIdBytes);
                            view.setBigUint64(0, BigInt(entry.projectId), true);
                            
                            const [projectPDA] = calculatePDA(
                                [new TextEncoder().encode('project'), new Uint8Array(projectIdBytes)],
                                MEMO_PROJECT_PROGRAM_ID
                            );

                            const projectAccount = await connection.getAccountInfo(projectPDA);
                            
                            if (projectAccount) {
                                const projectData = parseProjectData(projectAccount.data);
                                return {
                                    ...entry,
                                    name: projectData.name,
                                    website: projectData.website,
                                    description: projectData.description
                                };
                            } else {
                                return {
                                    ...entry,
                                    name: `Project ${entry.projectId}`,
                                    website: '',
                                    description: ''
                                };
                            }
                        } catch (error) {
                            console.error(`Error loading project ${entry.projectId}:`, error);
                            return {
                                ...entry,
                                name: `Project ${entry.projectId}`,
                                website: '',
                                description: ''
                            };
                        }
                    })
                );

                // Render table
                renderLeaderboard(projectDetails);

                // Hide loading and show table
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('leaderboardTable').style.display = 'block';
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                showError(`Failed to load leaderboard: ${error.message}`);
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Data';
            }
        }

        // Render leaderboard table
        function renderLeaderboard(projects) {
            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = '';

            projects.forEach((project, index) => {
                const rank = index + 1;
                const row = document.createElement('tr');
                
                const burnedMemo = Math.floor(Number(project.burnedAmount) / 1_000_000);
                
                row.innerHTML = `
                    <td class="rank">
                        <span class="rank-medal">${getRankMedal(rank)}</span>
                        ${rank}
                    </td>
                    <td class="project-id">${project.projectId}</td>
                    <td class="project-name">${project.name || `Project ${project.projectId}`}</td>
                    <td class="project-description">${truncateDescription(project.description)}</td>
                    <td>
                        ${project.website ? 
                            `<a href="${project.website}" target="_blank" rel="noopener noreferrer" class="website-link">${project.website}</a>` : 
                            '-'
                        }
                    </td>
                    <td class="burned-amount">${formatNumber(burnedMemo)}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            initConnection();
            loadLeaderboard();
        });
    </script>
</body>
</html>
